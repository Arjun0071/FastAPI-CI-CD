name: CD - Deploy FastAPI to Selected Cluster

on:
  workflow_dispatch:
    inputs:
      cluster:
        description: 'Select cluster to deploy (kubespray or kubeadm)'
        required: true
        default: 'kubespray'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository (optional, for logs or scripts)
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Start SSH agent with private key
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Step 3: Deploy to selected cluster via jump server
      - name: Deploy to Selected Cluster
        env:
          JUMP_HOST: ${{ secrets.JUMP_HOST }}       # public IP of jump server
          JUMP_USER: ${{ secrets.JUMP_USER }}       # SSH user
          IMAGE_TAG: ${{ github.event.workflow_run.head_commit.id }}  # CI SHA
          CLUSTER: ${{ github.event.inputs.cluster }}               # cluster choice
        run: |
          echo "Deploying to cluster: $CLUSTER"
          KUBECONFIG_FILE="~/.kube/config-$CLUSTER"
          ssh -o StrictHostKeyChecking=no ${JUMP_USER}@${JUMP_HOST} "
            export KUBECONFIG=$KUBECONFIG_FILE
            echo 'Using kubeconfig: $KUBECONFIG_FILE'
            helm upgrade --install demoapp /home/${JUMP_USER}/demoapp-chart \
              --set image.repository=${{ secrets.DOCKERHUB_USERNAME }}/fastapi-demo \
              --set image.tag=${IMAGE_TAG} \
              --set image.pullPolicy=Always \
              --namespace default \
              --atomic
          "
